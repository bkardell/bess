var Bess={version:"2.0.alpha1",loadedAttr:"data-bess-loaded",parsedAttr:"data-bess-parsed",type:"text/bess",rules:[],handlers:[],init:function(){var e,t,r='link[type="'+Bess.type+'"]',s='style[type="'+Bess.type+'"]',n=Bess.Parser.parse;if(e=$(r),t=$(s),e.length||t.length){var i=window.media&&window.media.query||function(e){if(!e)return!0;if(e in media)return media[e];var t=$('<style media="'+e+'">body {position: relative; z-index: 1;}</style>').appendTo("head");return media[e]=[1==$("body").css("z-index"),t.remove()][0]};e.length&&e.each(function(){var e=$(this),t=!this.disabled,r=!/^\w+:/.test(e.attr("href")),s=i(this.media),a=!e.attr(Bess.loadedAttr);t&&r&&s&&a&&$.get(this.href,function(t){n.call(Bess.Parser,t,e.context),e.attr(Bess.loadedAttr,"true")},"text")}),t.length&&t.each(function(){var e=$(this),t=!this.disabled,r=!e.attr(Bess.loadedAttr);t&&r&&(n.call(Bess.Parser,this.innerHTML,this),e.attr(Bess.loadedAttr,"true"))})}}};$.isReady?Bess.init():$(document).ready(Bess.init),Bess.Parser={parse:function(e,t){var r=new Bess.Scanner(e),s=new Bess.Scanner(e);this.parseAtRules(r,t).then(function(){var e=Bess.Parser.parseRules(s,t);Bess.rules=Bess.rules.concat(e),$(t).attr(Bess.parsedAttr,"true"),Bess.Engine.process()})},parseAtRules:function(e){var t,r,s,n=$.Deferred(),i=[],a=Bess.Utility.expressions(),o=Bess.Utility.makeImportPromise,u=function(e,t){var r=e.capture(e.index,e.readUntil(t).index);return e.advance(),r};if(e.skipWhitespace(),e.skipMultiLineComment(),e.isDone()||"@"!==e.current)n.resolve();else{for(;"@"===e.current;)e.advance(),e.sniff("import")?(e.skipWhitespace(),t=u(e,a.isOpenParen),e.advance(),r=u(e,a.isQuote),s=o(t,r),i.push(s),e.readUntil(a.isAtSymbol)):e.readUntil(a.isAtSymbol);$.when.apply($,i).then(function(){n.resolve()})}return n.promise()},parseRules:function(e,t){var r,s=[],n=Bess.Utility.expressions(),i=function(e){for(e.skipWhitespace();"@"===e.current;)e.readUntil(n.isSemi).advance(),e.skipWhitespace();return e},a=function(e,t){t.match(/\)/g)&&!t.match(/\(/g)?e.selectors[e.selectors.length-1]+=", "+t:e.selectors.push($.trim(t))},o=function(e,t){var r,s=t||{selectors:[],sourceIndex:e.index};return e.skipWhitespace(),e.skipMultiLineComment(),r=e.skipWhitespace().index,e.readUntil([n.isComma,n.isOpenBrace]),","===e.current?(a(s,e.capture(r,e.index)),e.advance(),o(e,s)):"{"===e.current?(a(s,e.capture(r,e.index)),e.advance(),s.declarations=u(e),s):void 0},u=function(e,t){var r,s=e.skipWhitespace().index,i=t||{};return e.skipMultiLineComment(),"}"!==e.current?(e.readUntil(n.isColon),r=e.capture(s,e.index),s=e.advance().skipWhitespace().index,e.readUntil(n.isSemi),i[r]=e.capture(s,e.index),e.advance(),u(e,i)):(e.advance(),i)};return e=i(e),e.skipWhitespace(),e.skipMultiLineComment(),e.isDone()?s:(r=this.parseRule(o(e),t),r.length>0&&(s=s.concat(r)),s)},parseRule:function(e,t){if(e){var r,s,n={},i=[],a=Bess.Utility.expressions(),o=Bess.Utility.Specificity.calculate,u=Bess.Modules;return $.each(e.declarations,function(e){var t=e.match(a.behavior);if(t){var r=t[2]?t[2]:t[1];r&&(n[r]=!0)}}),$.each(e.selectors,function(c){var l=e.selectors[c];$.isEmptyObject(n)||(r=l.split(a.pseudo),s={pseudo:r.pop(),select:r.join(":"),boundFrom:t},s.score=o(s.select),$.each(n,function(t){var r=u.find(t);if(!r)throw"Rule not parsed. Failed to find a module: "+t+" even though it's marked as relevant.";parsedRule=Bess.Parser.parseDeclaration(e.declarations,t,r.properties),i.push({ruleId:e.sourceIndex,selector:s,declaration:parsedRule,module:t})}))}),i}},parseDeclaration:function(e,t,r){var s={},n=e,i=e[t];i&&(n=$.extend({},this.parseShorthand(i,t,r),e));var a=function(e){var r=t+"-"+e,i=n[r];i&&(s[e]=$.isPlainObject(i)?i:Bess.Parser.parseValues(new Bess.Scanner(i))[0])};return $.each(r,function(e,t){a(t)}),s},parseShorthand:function(e,t,r){for(var s=this.parseValues(new Bess.Scanner(e),!0),n=0,i=0,a={},o=0;s.length>o;o++)r.length>o&&(a[t+"-"+r[i]]={}),s[o].x&&(i=0,n++),a[t+"-"+r[i]][n+""]=s[o],i++;return a},parseValues:function(e,t){var r,s=[],n=0,i={};for(n;;n++){if(r=this.nextValue(e),!r)return s;i[n]=r,s.push(t?r:i)}},nextValue:function(e){var t,r=Bess.Utility.expressions();if(!e.skipWhitespace().isDone()){if("'"===e.current)return{resolver:"string",arg:this.nextExpression(e.advance(),r.isQuote)};if(r.isNumeric.test(e.current))return{resolver:"number",arg:this.nextExpression(e,[r.whiteSpace,r.isSemi])};if(r.isComma.test(e.current))return t=this.nextValue(e.advance()),t.x=!0,t;var s={resolver:this.nextExpression(e,r.isOpenParen),arg:[]};if(r.isCloseParen.test(e.current))return e.advance(),s;for(t=this.nextValue(e,!0);t&&(s.arg.push(t),e.skipWhitespace().advance(),r.isComma.test(e.peek(-1)));)t=this.nextValue(e,!0);return s}},nextExpression:function(e,t){var r=e.capture(e.index,e.readUntil(t).index);return e.advance(),r}},Bess.Scanner=function(e){this.source=e},Bess.Scanner.prototype={toString:function(){return this.source},current:"BEGIN",test:null,index:0,tailIndex:function(){return this.source.length-1},setIndex:function(e){return this.current=this.source[e],this.index=e,this},readUntil:function(e){var t,r=0,s=e.length?e:[e];for(this.index;this.index<=this.tailIndex();this.index++)for(t=this.source.charAt(this.index),r=0;s.length>r;r++)if(s[r]&&s[r].test(t))return this.current=t,this.test=s[r],this;return this},sniff:function(e){var t=this.source.substr(this.index,e.length);return t===e?(this.index+=e.length,this.current=this.source.charAt(this.index),!0):!1},capture:function(e,t){return this.source.substring(e,t)},nextIndexOf:function(e){return this.source.indexOf(e,this.index)},tailIndexOf:function(e){return this.source.lastIndexOf(e,this.tailIndex())},peek:function(e){return this.source.charAt(this.index+(e||1))},isDone:function(e){return this.index>=(e||this.tailIndex())},advance:function(e){return this.index=this.index+(e||1),this.current=this.source.charAt(this.index),this},skipMultiLineComment:function(){"/"===this.current&&"*"===this.peek()&&(this.setIndex(this.nextIndexOf("*/")).advance(2),this.skipWhitespace())},skipWhitespace:function(){return this.readUntil([/\S/]),this}},Bess.Engine={process:function(){if(0!==Bess.rules.length){var e=Bess.Utility.Specificity.sort(Bess.rules),t=this.attach;$.each(e,function(e,r){t(r)})}},attach:function(e){var t=e.selector.pseudo,r=(e.selector,Bess.Utility.mapEventName(t));$(e.selector.select).live(r,e,Bess.Utility.globalHandler),Bess.handlers[r]||($(document).bind(r,function(e){var r,s={},n=$(e.currentTarget);if(e.actionable){if("html-inserted"===e.type){if(e.target.bess_dom_inserted)return!1;e.target.bess_dom_inserted=!0}if("html-modified"===e.type&&e.currentTarget!==e.target)return;-1!==e.type.indexOf("post-")?e.currentTarget=e.target:"html-inserted"===e.type&&e.currentTarget!==e.target?e.currentTarget=e.target:"submit"===e.type&&e.target.tagName&&"BUTTON"===e.target.tagName&&(e.target=e.currentTarget);for(var i=0;e.actionable.length>i;i++)r=e.actionable[i],s[r.module]=s[r.module]||{},r.selector.pseudo==t&&($(e.target).is(r.selector.select)||$(e.currentTarget).is(r.selector.select))&&$.extend(s[r.module],r.declaration);var a=function(e){e.topic?n.trigger("error"):e.target&&e.target.trigger("error")},o=function(){for(var t in s){var r=Bess.Modules.find(t);if(r)for(var i=Bess.Utility.multiplicityToArray(s[t]),o=0;i.length>o;o++){var u=$.extend({},r.defaults,i[o]);u.apply=r.apply,Bess.Resolver.resolveModule(u,n,e.message,a)}}};Bess.Utility.wrapAspects(t,n,o)}}),Bess.handlers[r]=!0)}},Bess.Resolver={resolveModule:function(e,t,r,s){var n,i={},a=Bess.Utility.watcher(i,e,t);for(n in e)e[n].resolver&&("none"===e[n].arg?delete e[n]:a.count++);try{for(n in e)e[n].resolver&&this.resolveProperty(n,e[n],t,a,r,s)}catch(o){s(i,o)}},resolveProperty:function(e,t,r,s,n,i){var a=[t],o=t.arg,u=function(e,t){e.arg.resolver&&(t.push(e.arg),u(e.arg,t))};$.isArray(t.arg)||u(t,a);var c=function(e,t){var s=e.replace(/th\(index\)/g,"th("+r.index()+")");return"string"==typeof e&&Bess.Utility.uniqueId(r,s)||t},l=function(e,t,r){return function(s,n){e--,t[this.i]=c(n,n),0===e&&r(t)}},d=function(t,s){for(var i,a,o=[],u=0;t.length>0;)i=t.shift(),a={i:u++,setVal:l(t.length,o,s)},this.resolveProperty(e,i,r,a,n)},p=function(t){if(t&&t.pop){var a=t.pop();if($.isArray(a.arg))d(a.arg.slice(0),function(t){if(type_resolvers[a.resolver])try{type_resolvers[a.resolver](r,t,s,e,n)}catch(o){i(a.resolver,o)}else Logger.error("unknown type resolver: '"+a.resolver+"'")});else if(o=c(a.arg,o),w=0===t.length?watch:{setVal:function(e,t){o=c(t,t),p()}},type_resolvers[a.resolver])try{type_resolvers[a.resolver](r,[o],w,prop,msg)}catch(u){i(a.resolver,u)}else Logger.error("unknown type resolver: '"+a.resolver+"' should it be in an array?")}};p(a)}},Bess.Modules={cache:[],find:function(e){return this.cache[e]},register:function(e,t){this.cache[e]=t}},Bess.Utility={expressions:function(){var e={isQuote:/\'/,isNumeric:/\d/,isSemi:/\;/,isOpenParen:/\(/,isCloseParen:/\)/,isOpenBrace:/\{/,isComma:/\,/,isColon:/\:/,isAtSymbol:/\@/,whiteSpace:/\s/,behavior:/^\-be\-([^\-]*)|^([a-z]*[A-z]*)/,pseudo:/\:/,pre:/\([^\)]+\)/,ids:/#[\d\w\-_]+/g,cls:/[\.:\[][^\.:\[+>]+/g,tag:/(^|[\s\+>])\w+/g};return e.chop=[e.ids,e.cls,e.tag],e},Specificity:{calculate:function(e){var t=Bess.Utility.expressions(),r=e.replace(t.pre,"");return parseInt(t.chop.map(function(e){var t=r.match(e);return t?t.length.toString(16):0}).join(""),16)},sort:function(e){return e.sort(function(e,t){return e.selector.score>t.selector.score?1:e.selector.score<t.selector.score?-1:0})}},makeImportPromise:function(type,url){var deferred=$.Deferred();return $.get(url,function(source){eval(source),deferred.resolve()},"text"),deferred.promise()},Resolvers:{string:function(e){return{resolver:"string",arg:e||""}},find:function(e){return{resolver:"find",arg:[this.string(e||":self")]}},object:function(e){return{resolver:"object",arg:e||"{}"}}},globalHandler:function(e,t){e.preventDefault(),e.actionable||(e.actionable=[],e.actionableIds=[],e.target=e.currentTarget||e.target),-1===$.inArray(e.data.module+":"+e.data.ruleId,e.actionableIds)&&(e.message=t,e.actionable.push(e.data),e.actionableIds.push(e.data.module+":"+e.data.ruleId))},mapEventName:function(e){var t={clicked:"click",changed:"change",blurred:"focusout",validated:"submit"},r=t[e]?t[e]:e;return"transitioned"==e&&(r=$.browser.webkit?"webkitTransitionEnd":$.browser.opera?"oTransitionEnd":$.browser.mozilla?"transitionend":"transitionend"),r},wrapAspects:function(e,t,r){t.queue("pseudo",[function(){t.trigger("pre-"+e).dequeue("pseudo")},function(){r(),t.dequeue("pseudo")},function(){t.trigger("post-"+e).dequeue("pseudo")}]),t.dequeue("pseudo")},multiplicityToArray:function(e){var t,r=function(e){var t={},r=null,s=null;for(r in e){var n=e[r];for(s in n)t[s]=!0}return t},s=[],n=r(e),i=null;for(i in n){t={};for(var a in e){if(!e[a][i])return s;t[a]=e[a][i]}s.push(t)}return s},watcher:function(e,t,r,s){return{count:0,setVal:s||function(s,n){e[s]=n,this.count--,0===this.count&&t.apply(e,r)}}},uniqueId:function(e,t){return e.attr("id")||e.attr("id","bess_"+$.now()),t.replace(":self","#"+e.attr("id"))}};